name: ECS Deploy Service

on:
  workflow_call:
    inputs:
      environment:
        description: "GitHub environment name"
        required: true
        type: string

      aws-region:
        description: "AWS region"
        required: false
        type: string
        default: us-east-1

      image:
        description: "Full container image URI"
        required: true
        type: string

      service:
        description: "Service to deploy: web | worker"
        required: true
        type: string

    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy ECS Service
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    env:
      AWS_REGION: ${{ inputs.aws-region }}
      IMAGE: ${{ inputs.image }}

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy service
        shell: bash
        run: |
          set -Eeuo pipefail

          # --------------------------------------------------
          # Resolve environment-specific ECS config
          # --------------------------------------------------

          case "${{ inputs.service }}" in
            web)
              cluster="${{ vars.ECS_CLUSTER }}"
              service="${{ vars.ECS_SERVICE }}"
              container="${{ vars.ECS_CONTAINER_NAME }}"
              ;;
            worker)
              cluster="${{ vars.ECS_WORKER_CLUSTER }}"
              service="${{ vars.ECS_WORKER_SERVICE }}"
              container="${{ vars.ECS_WORKER_CONTAINER_NAME }}"
              ;;
            *)
              echo "❌ Unknown service: ${{ inputs.service }}"
              exit 1
              ;;
          esac

          image="$IMAGE"

          test -n "$cluster" || { echo "ECS cluster missing"; exit 1; }
          test -n "$service" || { echo "ECS service missing"; exit 1; }
          test -n "$container" || { echo "Container name missing"; exit 1; }
          test -n "$image" || { echo "Image missing"; exit 1; }

          echo "Deploying $image"
          echo "Cluster: $cluster"
          echo "Service: $service"
          echo "Container: $container"

          # --------------------------------------------------
          # Rollback handler
          # --------------------------------------------------

          rollback() {
            echo "⚠️ Rolling back service"

            aws ecs update-service \
              --cluster "$cluster" \
              --service "$service" \
              --task-definition "$OLD_TD_ARN"

            aws ecs wait services-stable \
              --cluster "$cluster" \
              --services "$service"
          }

          trap rollback ERR

          # --------------------------------------------------
          # Fetch current task definition
          # --------------------------------------------------

          OLD_TD_ARN=$(aws ecs describe-services \
            --cluster "$cluster" \
            --services "$service" \
            --query "services[0].taskDefinition" \
            --output text)

          aws ecs describe-task-definition \
            --task-definition "$OLD_TD_ARN" \
            --query taskDefinition > td.json

          # --------------------------------------------------
          # Update container image
          # --------------------------------------------------

          jq --arg img "$image" --arg name "$container" '
            .containerDefinitions |= map(
              if .name == $name then .image = $img else . end
            )
            | del(
                .revision,
                .status,
                .taskDefinitionArn,
                .requiresAttributes,
                .compatibilities,
                .registeredAt,
                .registeredBy
              )
          ' td.json > td-register.json

          # --------------------------------------------------
          # Register new task definition
          # --------------------------------------------------

          NEW_TD_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://td-register.json \
            --query taskDefinition.taskDefinitionArn \
            --output text)

          # --------------------------------------------------
          # Update service
          # --------------------------------------------------

          aws ecs update-service \
            --cluster "$cluster" \
            --service "$service" \
            --task-definition "$NEW_TD_ARN"

          aws ecs wait services-stable \
            --cluster "$cluster" \
            --services "$service"

          trap - ERR
          echo "✅ Service deployed"
